# MagaDrive Pricing Service C++ - T8-T10
# Makefile –¥–ª—è —Å–±–æ—Ä–∫–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

CXX = g++
CXXFLAGS = -std=c++17 -Wall -Wextra -O2 -Ivendor
LDFLAGS = -pthread

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
PORT ?= 8003
BASE_PRICE ?= 100.0
PRICE_PER_KM ?= 15.0
PRICE_PER_MINUTE ?= 3.0

# –§–∞–π–ª—ã
TARGET = pricing_service
SOURCES = main.cpp
VENDOR_DIR = vendor

# –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
.PHONY: all build clean run test install help

all: build ## –°–æ–±—Ä–∞—Ç—å –≤—Å–µ

build: $(TARGET) ## –°–æ–±—Ä–∞—Ç—å —Å–µ—Ä–≤–∏—Å
	@echo "‚úÖ Pricing Service —Å–æ–±—Ä–∞–Ω: $(TARGET)"

$(TARGET): $(SOURCES)
	@echo "üî® –ö–æ–º–ø–∏–ª—è—Ü–∏—è Pricing Service..."
	$(CXX) $(CXXFLAGS) -o $(TARGET) $(SOURCES) $(LDFLAGS)

clean: ## –û—á–∏—Å—Ç–∏—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —Å–±–æ—Ä–∫–∏
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞..."
	rm -f $(TARGET)
	rm -rf build/

run: build ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å
	@echo "üöÄ –ó–∞–ø—É—Å–∫ Pricing Service –Ω–∞ –ø–æ—Ä—Ç—É $(PORT)..."
	PORT=$(PORT) \
	BASE_PRICE=$(BASE_PRICE) \
	PRICE_PER_KM=$(PRICE_PER_KM) \
	PRICE_PER_MINUTE=$(PRICE_PER_MINUTE) \
	./$(TARGET)

test: build ## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞
	@echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Pricing Service..."
	@echo "‚ö†Ô∏è  –î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—É—Å—Ç–∏—Ç–µ 'make run' –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã"
	@echo "   GET  http://localhost:$(PORT)/healthz"
	@echo "   GET  http://localhost:$(PORT)/readyz"
	@echo "   POST http://localhost:$(PORT)/price"

# Docker –∫–æ–º–∞–Ω–¥—ã
docker-build: ## –°–æ–±—Ä–∞—Ç—å Docker –æ–±—Ä–∞–∑
	@echo "üê≥ –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞..."
	docker build -t magadrive/pricing-service .

docker-run: docker-build ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ Docker
	@echo "üê≥ –ó–∞–ø—É—Å–∫ –≤ Docker –Ω–∞ –ø–æ—Ä—Ç—É $(PORT)..."
	docker run --rm -p $(PORT):$(PORT) \
		-e PORT=$(PORT) \
		-e BASE_PRICE=$(BASE_PRICE) \
		-e PRICE_PER_KM=$(PRICE_PER_KM) \
		-e PRICE_PER_MINUTE=$(PRICE_PER_MINUTE) \
		magadrive/pricing-service

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
install-deps: ## –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
	@echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏..."
	@if [ ! -d "$(VENDOR_DIR)" ]; then mkdir -p $(VENDOR_DIR); fi
	@if [ ! -d "$(VENDOR_DIR)/nlohmann" ]; then mkdir -p $(VENDOR_DIR)/nlohmann; fi
	@echo "‚ÑπÔ∏è  Vendor –∑–∞–≥–ª—É—à–∫–∏ —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã –≤ $(VENDOR_DIR)/"
	@echo "üí° –î–ª—è production –∑–∞–º–µ–Ω–∏—Ç–µ –∑–∞–≥–ª—É—à–∫–∏ –Ω–∞ –ø–æ–ª–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:"
	@echo "   - httplib.h: https://github.com/yhirose/cpp-httplib"
	@echo "   - nlohmann/json.hpp: https://github.com/nlohmann/json"

# CMake —Å–±–æ—Ä–∫–∞ (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞)
cmake-build: ## –°–±–æ—Ä–∫–∞ —á–µ—Ä–µ–∑ CMake
	@echo "üî® CMake —Å–±–æ—Ä–∫–∞..."
	mkdir -p build
	cd build && cmake .. -DCMAKE_BUILD_TYPE=Release
	cd build && make

cmake-debug: ## Debug —Å–±–æ—Ä–∫–∞ —á–µ—Ä–µ–∑ CMake
	@echo "üî® CMake Debug —Å–±–æ—Ä–∫–∞..."
	mkdir -p build
	cd build && cmake .. -DCMAKE_BUILD_TYPE=Debug
	cd build && make

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
check: ## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
	@echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞..."
	@if command -v cppcheck >/dev/null 2>&1; then \
		cppcheck --enable=all --std=c++17 $(SOURCES); \
	else \
		echo "‚ö†Ô∏è  cppcheck –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑"; \
	fi

# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
format: ## –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
	@echo "‚ú® –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞..."
	@if command -v clang-format >/dev/null 2>&1; then \
		clang-format -i $(SOURCES); \
		echo "‚úÖ –ö–æ–¥ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω"; \
	else \
		echo "‚ö†Ô∏è  clang-format –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"; \
	fi

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
info: ## –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ
	@echo "=== MagaDrive Pricing Service C++ ==="
	@echo "–í–µ—Ä—Å–∏—è: 1.0.0 T8-T10"
	@echo "–ü–æ—Ä—Ç: $(PORT)"
	@echo "–ö–æ–º–ø–∏–ª—è—Ç–æ—Ä: $(CXX)"
	@echo "–§–ª–∞–≥–∏: $(CXXFLAGS)"
	@echo "–ò—Å—Ö–æ–¥–Ω–∏–∫–∏: $(SOURCES)"
	@echo "Vendor: $(VENDOR_DIR)/"
	@echo ""
	@echo "–≠–Ω–¥–ø–æ–∏–Ω—Ç—ã:"
	@echo "  GET  /healthz - Health check"
	@echo "  GET  /readyz  - Ready check"
	@echo "  POST /price   - –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏"

help: ## –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–º–æ—â—å
	@echo "MagaDrive Pricing Service C++ - –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'
